<!DOCTYPE html>
<html lang="ZH-cn" data-identity="85">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0,minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>成果管理-新建成果</title>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="../../assets/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="../../assets/css/cmui.min.css"/>
    <link rel="stylesheet" href="../../assets/css/base.min.css"/>
    <link rel="stylesheet" href="../../assets/css/innerbase.min.css"/>
    <!--[if lt IE 9]>
    <script src="../../assets/lib/html5shiv.js"></script>
    <script src="../../assets/lib/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        .modal-body p {
            font-size: 14px;
            color: #333;
        }

        .modal-body .con {
            max-width: 80%;
            margin: 0 auto;
            margin-top: 25px;
        }

        .dialog-sm .modal-dialog {
            width: 670px;
        }

        h5.text_info_red {
            color: #fda68a;
            font-size: 14px;
        }

        h5.text_info {
            font-size: 14px;
        }

        :-ms-input-placeholder {
            color: #CCCCCC;
        }

        .upload .remove {
            background: url(../../../assets/imgs/bigtopic-delete.png) no-repeat 5px 13px;
            width: 20px;
            height: 41px;
            float: left;
        }

        .failfile {
            background: url(../../../assets/imgs/bigtopic-error.png) no-repeat;
            color: #ccc;
        }

        .failupload {
            color: #fc6a3c;
            font-size: 12px;
            line-height: 20px;
        }

        .failfile:hover {
            background: url(../../../assets/imgs/bigtopic-error.png) no-repeat;
            color: #ccc;
        }

        .upload img {
            width: 41px;
            height: 41px;
        }

        .form-control {
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="main-container">
    <ol class="breadcrumb">
        <li>web内容管理</li>
        <li>成果管理</li>
        <li>新建成果</li>
    </ol>
    <div class="tile">
        <div class="module-header"><h4>新建成果</h4></div>
        <div class="tile-content mt-40">
            <div class="form">
                <form id='addProject' acion='xxx.action'>
                    <div class="col-md-12 mt-5">
                        <div class="form-group">
                            <label for="activity_name">成果名称：</label>
                            <input class="form-control" type="text" id="activity_name" name="activity_name"
                                   placeholder="不超过15个字符" required>
                        </div>
                        <div class="form-group">
                            <label for="result_classify">成果类型：</label>
                            <select class="form-control" name="result_classify" id="result_classify">
                                <option value="">请选择...</option>
                                <option value="1" data-tagname='APP'>APP</option>
                                <option value="2" data-tagname='WEB'>WEB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="activity_job">支持平台：</label>
                            <input class="form-control" type="text" iname="activity_job" id="activity_job"
                                   placeholder="" required>
                        </div>
                        <div class="form-group">
                            <label for="result_source">成果来源：</label>
                            <input class="form-control" type="text" name="a" id="result_source" placeholder="不超过15个字符"
                                   required>
                        </div>
                        <div class="form-group">
                            <label>成果logo：</label>
                            <div class="upload">
                                <div class="imgList"></div>
                                <div class="btns" title="上传附件">
                                    <div id="pickers">
                                        <img src="../../../assets/imgs/icon-upload.png" id="imgUpload-btn"/>
                                        <!--i class="imgUpload-info">重新上传</i>-->
                                    </div>
                                </div>
                                <div class="info">建议图片尺寸为160*160像素，支持JPG，PNG格式，大小20K以内</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="project_con" style="vertical-align: top;">成果简介：</label>
                            <textarea class="form-control" name="project_con" id="project_con" placeholder="不超过200个字符"
                                      required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="project_con" style="vertical-align: top;">成果展示图：</label>
                            <div class="upload">
                                <div class="imgList"></div>
                                <div class="btns" title="上传附件">
                                    <div id="pickers-2">
                                        <img src="../../../assets/imgs/icon-upload.png" id="imgUpload-btn-2"/>
                                        <!--i class="imgUpload-info">重新上传</i>-->
                                    </div>
                                </div>
                                <div class="info">建议图片尺寸为160*160像素，支持JPG，PNG格式，大小20K以内</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="result_url">成果URL：</label>
                            <input class="form-control" type="text" name="result_url" id="result_url" placeholder=""
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="result_status">状态：</label>
                            <lable><input type="checkbox" value="" class="check"/>定时发布</lable>
                        </div>
                    </div>
            </div>
        </div>
        <button class="btn-green w80 ml-100" data-toggle="modal" id="project-save-btn">发布</button>
        <button class="btn-blue ml-10 w80" data-toggle="modal" id="project-add-btn">取消</button>
        <p class="info-green ml-100 mt-10">保存为草稿</p>
        </form>
    </div>


</div>
<script src="../../assets/lib/require.js"></script>
<script src="../../assets/js/config.js"></script>
<script>
    require(["common", "bootstrap", "webtools", "validate"], function (c, b, w, v) {

        validateDate.submitHandler = function () {
            if (!uploaderFlag) {
                alert('还有文件上传中...请稍后提交');
                return false;
            }
            if (formBtn == 1) {
                updateTosecond(4, $("#second"))
            } else {
                //callback for this...
                alert(formBtn);
            }
        }
        $("#addProject").validate(validateDate);
        UploadImg.url = 'http://localhost:8080/shuangchuang';
        var imgupload = w.upload(UploadImg).check(),
                fileupload = w.upload(UploadFiles).check(),
                $imglist = $('.imgList'),
                $filelist = $('#thelist-jihuashu'),
                flag = false,
                fileInputVal = $().val(),
                uploaderFlag = false,
                arr = [],
                num = '';


        //图片上传
        imgupload.on('fileQueued', function (f) {
            //上传之前移除队列
            imgupload.removeFile(imgupload.getFile(f.id, true));
            $item = $('<img title=' + f.name + ' id="imgShow"/>');
            $imglist.html($item);
            imgupload.makeThumb(f, function (error, src) {
                $('#imgShow').attr('src', src);
                $('.p_logo img').attr('src', src);
            });
            if (!flag) {
                $('#pickers').append('<i class="imgUpload-info">重新上传</i>');
                flag = true;
            }
            $('#imgUpload-btn').hide();
        }).on('uploadSuccess', function (res, f) {

        }).on('uploadError', function (f, s) {
            console.log(s);
        }).on('uploadAccept', function (o, r) {
            console.log(o + r);
        });
        //文件上传

        fileupload.on('fileQueued', function (f) {
            uploaderFlag = false;
        }).on('uploadProgress', function (f, p) {
            var $progress = $('<div id=progressBox' + f.id + ' class="progressBox"><p title=' + f.name + '>' + f.name + '</p><div class="progress" style="width:155px"><div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div></div></div>'),
                    $percent = $progress.find('.progress-bar');
            if (!$filelist.find('.progress').length) {
                $filelist.append($progress);
            }
            $percent.css('width', p * 100 + '%');
        }).on('uploadSuccess', function (f) {
            $('#progressBox' + f.id).remove();
            $item = $('<a class="jihuashu mr-20" id="' + f.id + '" title=' + f.name + '><font class="jihuashu-info">' + f.name + '</font><i class="remove">&nbsp;</i></a>');
            $item_show = $('<a class="jihuashu mr-20" id="' + f.id + '" title=' + f.name + '><font class="jihuashu-info">' + f.name + '</font></a>')
            $filelist.append($item);
            $('.p_res').append($item_show);
            $item.on('click', '.remove', function () {
                fileupload.removeFile(fileupload.getFile(f.id, true));
                $('#' + f.id).remove();
            });
            uploaderFlag = true;
        }).on('uploadError', function (f, s) {
            $('#progressBox' + f.id).remove();
            $item = $('<a class="jihuashu mr-20 failfile" id="' + f.id + '" title=' + f.name + '><font class="jihuashu-info">' + f.name + '</font><i class="remove"></i></a>');
            $item_show = $('<a class="jihuashu mr-20 failfile" id="' + f.id + '" title=' + f.name + '><font class="jihuashu-info">' + f.name + '</font></a>');
            $filelist.append($item);
            $('.p_res').append($item_show);
            arr.push(f.name);
            $("#failupload").html(arr.join('，') + "上传失败,请重新上传!");
            $item.on('click', '.remove', function () {
                num = $(this).parent('.failfile').index();
                fileupload.removeFile(fileupload.getFile(f.id, true));
                $('#' + f.id).remove();
                arr.splice(num, 1);
                !arr.length == 0 ? $("#failupload").html(arr.join('，') + "上传失败,请重新上传!") : $("#failupload").html('');
            });
        })
        //执行初始化上传文件方法
        var fileNumInput = function (index) {
            var files = $('#input').val();
            if (files.charAt(files.length - 1) == ',') {
                files = files.substring(files.length - 1, 1);
            }
            filesArr = files.split(',');
            filesArr.splice(index, 1);
            filesArr.join(',');
            $('#input').val(filesArr);
            return filesArr.length;
        }
        //绑定事件
        $('#saveProject,#project-add-btn').on('click', function () {
            flag = true;
        });
        document.body.onbeforeunload = function () {
            if (!flag) return '您尚有未保存的内容，离开将丢失此内容。'
        };
        //同步文件上传
        $('#project-add-btn').on('click', function () {
            var fileArray = [],
                    HTML = '';
            $('.jihuashu-info').each(function () {
                fileArray.push($(this).text());
            });
            for (var i = 0; i < fileArray.length; i++) {
                HTML += '<a class="jihuashu mr-20" title="' + fileArray[i] + '"><font class="jihuashu-info">' + fileArray[i] + '</font></a>';
            }
            $('.p_res').html(HTML);
        });
        function updateTosecond(second, ele, url) {
            var i = second || 4,
                    autoplay = setInterval(fun, 1000);

            function fun() {
                if (i == 0) {
                    location.href = url || '${ctx}/project/list';
                    clearInterval(autoplay);
                }
                ele.text(i);
                i--;
            }
        }
    });
</script>
</body>
</html>